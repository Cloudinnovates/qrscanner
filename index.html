<html>
<head>
	<meta charset="utf-8">
	<meta name="description" content="Free QR Scanner">
	<meta name="keywords" content="qr,reader,scanner,decoder,掃描,解碼">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>QR code Reader</title>
	<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="resources/js/adapter-latest.js"></script>
	<script type="text/javascript" src="resources/js/html5-qrcode.min.js"></script>
	<script type="text/javascript" src="resources/js/vendor/foundation.min.js"></script>
	<script type="text/javascript" src="resources/js/app.js"></script>
	<link rel="stylesheet" href="resources/css/foundation.min.css"/>
	<script type="text/javascript">
		
		var gCanvas=null;
		var gCtx=null;
		var v=null;
		
		var deviceList=[];
		
		$(function(){

			v=document.getElementById("v");
			
			gCanvas = document.getElementById("qr-canvas");
			gCtx = gCanvas.getContext("2d");
			gCtx.clearRect(0, 0, 300, 300);

			findDevice();
	
			$("#deviceList").change(function(){
			
				  if (window.stream) {
					window.stream.getTracks().forEach(function(track) {
					  track.stop();
					});
				  }
			
				device=deviceList[parseInt($("#deviceList").val())];
			
				console.log(device);
			
				var isBack=device.label.search("back")>-1;
				
				var option={
					deviceId:{exact:device.deviceId},
					facingMode:isBack?"environment":"user"
				}
				setcam2(option);
			})
	
			setcam2(true);
			//setTimeout(function(){$("#deviceList").change();}, 5000);

		});

		function findDevice(){

			try{
			
				navigator.mediaDevices.enumerateDevices().then(function(devices){
				
					devices.forEach(function(device){
						if(device.kind=="videoinput"){
							deviceList.push(device);
						}
					})
					
					for(i=0;i<deviceList.length;i++){
						$("#deviceList").append("<option value='"+i+"'>"+deviceList[i].label+"</option>");
					}

				});

			}catch(e){
				console.log(e);
			}

		}
		
		function gotStream(stream) {
			window.stream = stream; // make stream available to console
			v.srcObject = stream;
		  // Refresh button list in case labels have become available
		  return navigator.mediaDevices.enumerateDevices();
		}
		
		function setcam2(options){
		
			var constraints={video: options, audio: false};
		
			navigator.mediaDevices.getUserMedia(constraints).then(gotStream);
			
			setTimeout(captureToCanvas, 500);
		}

		function captureToCanvas() {

			try{
				gCtx.drawImage(v,0,0);
				try{
					var result=qrcode.decode();
					$("#result").html(result);
					setTimeout(captureToCanvas, 300);
				}catch(e){       
					console.log(e);
					setTimeout(captureToCanvas, 300);
				}
			}
			catch(e){
				console.log(e);
				setTimeout(captureToCanvas, 300);
			}

		}
		
	</script>
</head>
<body>
	<div class="row">
		<div class="large-5 medium-7 small-12 small-centered columns">
			<h2 style="text-align:center">QR Reader</h2>
			<div style="min-width">
				<div><video id="v" width="100%" autoplay></video></div>
				<canvas id="qr-canvas" width="500px" height="500px" style="display:none"></canvas>
				<select id="deviceList"></select>
				<div id="result" style="border:1px dashed gray;min-height:50px"></div>
			</div>
		</div>
	</div>
</body>
</html>